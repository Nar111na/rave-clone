<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>rAve Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- –ü–†–ï–ú–ò–£–ú –î–ò–ó–ê–ô–ù --- */
        body { 
            font-family: 'Inter', sans-serif; 
            /* –ì–ª—É–±–æ–∫–∏–π, –¥–æ—Ä–æ–≥–æ–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
            background: linear-gradient(180deg, #1a0b2e 0%, #0d041a 60%, #000000 100%); 
            color: white; min-height: 100vh; margin: 0; padding: 0; overflow-x: hidden;
        }
        /* –õ–æ–≥–æ—Ç–∏–ø —Ç–æ—á–Ω–æ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ */
        .rave-logo { font-size: 76px; font-weight: 900; letter-spacing: -3px; font-style: italic; }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç –¥–æ—Ä–æ–≥–æ–≥–æ —Å—Ç–µ–∫–ª–∞ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .glass { 
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        input::placeholder { color: rgba(255, 255, 255, 0.4); font-weight: 500; }
        
        /* –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏" - –±–µ–ª–∞—è, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è */
        .btn-primary { background: #ffffff; color: black; font-weight: 700; transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.97); opacity: 0.9; }

        /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–º–Ω–∞—Ç—ã (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ) */
        .room-card-vertical { 
            border-radius: 20px; overflow: hidden; position: relative;
            aspect-ratio: 2/3; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ—Å—Ç–µ—Ä–∞ */
        }
        .room-card-vertical img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            padding: 20px;
        }

        /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ "+" */
        .fab { position: fixed; bottom: 30px; right: 25px; width: 64px; height: 64px; background: white; color: black; border-radius: 50%; font-size: 36px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 50; }
        
        #player-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; }
    </style>
</head>
<body class="antialiased">

    <div id="auth-screen" class="flex flex-col items-center px-6 h-screen justify-center pb-20">
        <h1 class="rave-logo mb-4 text-white">r<span>Œõ</span>ve</h1>
        <p class="text-center text-lg mb-12 opacity-70 font-medium">–≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ —Å –¥—Ä—É–∑—å—è–º–∏</p>
        
        <div class="w-full max-w-sm space-y-4">
            <input id="email" type="email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" class="glass w-full p-4 rounded-2xl outline-none text-lg focus:border-white/30 transition-all">
            <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="glass w-full p-4 rounded-2xl outline-none text-lg focus:border-white/30 transition-all">
            <button onclick="handleAuth()" id="auth-btn" class="btn-primary w-full p-4 rounded-2xl text-lg shadow-xl">
                –í–æ–π—Ç–∏ –∏–ª–∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </button>
        </div>
        
        <div class="mt-8 flex gap-6 text-sm font-semibold opacity-60 underline decoration-white/30">
            <button>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button>–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
        </div>
        <p id="auth-error" class="text-red-500 text-sm mt-4 hidden p-2 glass rounded text-center"></p>
    </div>

    <div id="discovery-screen" class="hidden px-5 pt-12 pb-24 animate-fade-in">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-[34px] font-black tracking-tight">–ü—É–±–ª–∏—á–Ω—ã–µ</h2>
            <div class="w-11 h-11 glass rounded-full flex items-center justify-center text-lg shadow-lg">üë§</div>
        </div>

        <div class="relative mb-10">
            <input type="text" placeholder="–ü–æ–∏—Å–∫" class="glass w-full p-4 rounded-[20px] outline-none pl-12 text-lg shadow-sm">
            <span class="absolute left-4 top-5 opacity-40 text-xl">üîç</span>
        </div>

        <div id="rooms-list" class="grid grid-cols-2 gap-4">
            </div>

        <button onclick="createNewRoom()" class="fab">+</button>
    </div>

    <div id="player-screen" class="hidden px-4 pt-8 h-screen flex flex-col">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="location.reload()" class="w-11 h-11 glass rounded-full flex items-center justify-center font-bold text-xl">‚Üê</button>
            <h3 id="room-title" class="font-bold truncate text-lg opacity-90">–ö–æ–º–Ω–∞—Ç–∞</h3>
        </div>
        
        <div class="flex-1 flex flex-col justify-center mb-20">
            <div id="player-container" class="shadow-2xl">
                <div id="player"></div>
            </div>

            <div class="mt-8 glass p-5 rounded-[24px] flex items-center gap-4">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-[0_0_15px_#22c55e]"></div>
                <div>
                    <p class="text-sm font-bold">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞</p>
                    <p class="text-[11px] opacity-50 font-medium mt-0.5">–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∏–¥—è—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –º–æ–º–µ–Ω—Ç</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –¢–í–û–ò –î–ê–ù–ù–´–ï (–ù–ï –ú–ï–ù–Ø–ô)
        const SB_URL = 'https://mjjcaxonfeyiowjcpdid.supabase.co'; 
        const SB_KEY = 'sb_publishable_tl8JCaX8oMDxZY3Edkb0RQ_PLXkyRUH';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        let player, currentRoomId, isRemote = false;

        // --- –õ–û–ì–ò–ö–ê (–û–°–¢–ê–ï–¢–°–Ø –ü–†–ï–ñ–ù–ï–ô, –ù–û –°–¢–ê–ë–ò–õ–¨–ù–ï–ï) ---
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-btn');
            const errTxt = document.getElementById('auth-error');

            if (!email || !password) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
            btn.innerText = '–ü—Ä–æ–≤–µ—Ä–∫–∞...'; errTxt.classList.add('hidden');

            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) {
                const { error: signUpErr } = await _supabase.auth.signUp({ email, password });
                if (signUpErr) {
                    errTxt.innerText = signUpErr.message;
                    errTxt.classList.remove('hidden');
                    btn.innerText = '–í–æ–π—Ç–∏ –∏–ª–∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                } else {
                    alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ –í–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑.');
                    btn.innerText = '–í–æ–π—Ç–∏';
                }
            } else { showDiscovery(); }
        }

        function showDiscovery() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('discovery-screen').classList.remove('hidden');
            loadRooms();
        }

        async function loadRooms() {
            const { data: rooms } = await _supabase.from('rooms').select('*').order('last_updated', { ascending: false });
            const list = document.getElementById('rooms-list');
            list.innerHTML = rooms?.length ? '' : '<p class="col-span-2 text-center opacity-40 py-20 font-medium">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>';
            
            rooms?.forEach(room => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç–µ—Ä—ã (maxresdefault) –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                const img = `https://img.youtube.com/vi/${room.video_id}/maxresdefault.jpg`;
                list.innerHTML += `
                    <div class="room-card-vertical shadow-xl active:scale-95 transition-transform" onclick="joinRoom('${room.id}', '${room.video_id}', '${room.title}')">
                        <img src="${img}" loading="lazy">
                        <div class="card-overlay">
                            <h3 class="font-bold text-sm leading-tight line-clamp-2 mb-3">${room.title || '–í–∏–¥–µ–æ'}</h3>
                            <div class="flex -space-x-2 opacity-80">
                                <div class="w-8 h-8 rounded-full bg-purple-600 border-2 border-black flex items-center justify-center text-[10px] font-bold">üë§</div>
                                <div class="w-8 h-8 rounded-full glass border-2 border-black flex items-center justify-center text-[10px] font-bold">+</div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function joinRoom(id, vid, title) {
            currentRoomId = id;
            document.getElementById('room-title').innerText = title;
            document.getElementById('discovery-screen').classList.add('hidden');
            document.getElementById('player-screen').classList.remove('hidden');
            
            if (!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                window.onYouTubeIframeAPIReady = () => startPlayer(vid);
                document.head.appendChild(tag);
            } else { player.loadVideoById(vid); initRealtime(); }
        }

        function startPlayer(vid) {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: vid,
                playerVars: { 'playsinline': 1, 'controls': 1, 'modestbranding': 1, 'rel': 0 },
                events: { 'onStateChange': onStateChange, 'onReady': initRealtime }
            });
        }

        async function onStateChange(e) {
            if (isRemote || !player) return;
            if (e.data === 1 || e.data === 2) {
                await _supabase.from('rooms').upsert({ 
                    id: currentRoomId, playback_time: player.getCurrentTime(), is_playing: (e.data === 1), last_updated: new Date()
                });
            }
        }

        function initRealtime() {
            _supabase.channel('sync-' + currentRoomId)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${currentRoomId}` }, payload => {
                    const d = payload.new; isRemote = true;
                    if (Math.abs(player.getCurrentTime() - d.playback_time) > 2) player.seekTo(d.playback_time);
                    if (d.is_playing) player.playVideo(); else player.pauseVideo();
                    setTimeout(() => isRemote = false, 500);
                }).subscribe();
        }

        async function createNewRoom() {
            const url = prompt("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ YouTube:"); if (!url) return;
            const vid = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
            const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:", "–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞");
            const id = 'room-' + Date.now();
            await _supabase.from('rooms').insert({ id, video_id: vid, title });
            loadRooms(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        }
    </script>
</body>
</html>
